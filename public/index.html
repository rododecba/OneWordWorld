<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LIBRE</title>
  <link rel="icon" type="image/png" href="logolibre-favicon.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <style>
    html { transition: background-color 0.3s, color 0.3s; }
    .logo-hidden { opacity: 0; transition: opacity 1.5s; }
    .logo-shown { opacity: 1; transition: opacity 1.5s; }
    #logolibre { opacity: 0; transition: opacity 1.5s; }
    #logolibre.visible { opacity: 1; transition: opacity 1.5s; }
    #map { width: 100%; height: 250px; border-radius: 1rem; margin-bottom: 1rem; }
    .reply-thread { margin-left: 1.5rem; border-left: 2px solid #ddd; padding-left: 1rem; }
    .stat-label { color: #059669; font-weight: 600; font-size: .93rem;}
  </style>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
</head>
<body class="bg-gray-50 text-gray-800 min-h-screen flex flex-col items-center p-4">
  <header class="mb-6 text-center w-full max-w-xl">
    <div id="logoContainer" class="relative h-16 mt-6 text-3xl font-semibold flex items-center justify-center">
      <h1 id="textLogo" class="absolute logo-shown">LIBRE</h1>
      <img id="logolibre" src="logolibre.png" alt="LIBRE logo" class="absolute w-8 h-8" />
    </div>
    <p class="mt-1 text-[0.77rem] font-medium whitespace-normal">Un espacio para tus pensamientos m√°s libres. Escribe lo que quieras, sin esperar nada a cambio.<br>Tus palabras ser√°n una botella lanzada al mar, encontrada por alguien en alg√∫n lugar del mundo, sin saber qui√©n eres, ni qui√©n la encontr√≥.</p>
    <div class="mt-4 text-lg font-medium">
      <span id="globalCount">üåê <span id="globalCountNum">0</span> pensamientos lanzados</span>
    </div>
  </header>

  <nav class="w-full max-w-xl flex justify-around mb-6 text-sm">
    <button onclick="showTab('write')" class="hover:underline">Escribir</button>
    <button onclick="showTab('feed')" class="hover:underline">Pensamientos globales</button>
    <button onclick="showTab('mine')" class="hover:underline">Mis pensamientos</button>
    <button onclick="showTab('capsule')" class="hover:underline">C√°psula del tiempo</button>
    <button onclick="showTab('about')" class="hover:underline">Acerca de</button>
  </nav>

  <!-- Pensamientos globales con fondo violeta e icono globo terr√°queo -->
  <section id="feed" class="w-full max-w-xl mb-8 hidden">
    <div class="rounded-2xl bg-purple-100 border border-purple-300 p-6 shadow-md relative">
      <div class="flex items-center mb-4">
        <span class="text-3xl mr-2">üåç</span>
        <h2 class="text-2xl font-semibold text-purple-800">Pensamientos de todo el mundo</h2>
      </div>
      <div id="map"></div>
      <div id="countryRanking" class="mb-4"></div>
      <button id="randomBottleBtn" class="mb-2 px-4 py-2 rounded-lg bg-purple-500 text-white shadow-md hover:bg-purple-600 transition">Modo Botella al Mar (Random)</button>
      <button id="chainModeBtn" class="mb-2 px-4 py-2 rounded-lg bg-indigo-500 text-white shadow-md hover:bg-indigo-600 transition">Modo Cadena de pensamientos</button>
      <div id="randomThought" class="p-4 bg-white rounded-lg shadow-sm mb-4 hidden"></div>
      <div id="chainSection" class="mb-4 hidden"></div>
      <div id="globalThoughts" class="space-y-4"></div>
      <div class="my-5 border-t pt-4">
        <div class="font-semibold text-purple-800 mb-2">Ranking de palabras positivas:</div>
        <div id="positiveWordsRanking"></div>
      </div>
    </div>
  </section>

  <!-- Historial de mensajes con fondo verde e icono de historial -->
  <section id="mine" class="w-full max-w-xl mb-8 hidden">
    <div class="rounded-2xl bg-green-100 border border-green-300 p-6 shadow-md relative">
      <div class="flex items-center mb-4">
        <span class="text-3xl mr-2">üìú</span>
        <h2 class="text-2xl font-semibold text-green-800">Historial de mensajes</h2>
      </div>
      <div class="flex mb-3">
        <button onclick="exportAnonId()" class="px-3 py-1 rounded bg-gray-300 mr-2 text-sm">Exportar ID</button>
        <button onclick="importAnonId()" class="px-3 py-1 rounded bg-gray-300 text-sm">Importar ID</button>
      </div>
      <div class="mb-4 text-xs text-green-900 opacity-60">Para mantener tu historial aunque borres cach√© o cambies de dispositivo, exporta tu ID y gu√°rdalo en un lugar seguro. S√≥lo t√∫ lo conoces.</div>
      <div id="userStats" class="mb-4"></div>
      <div id="myThoughts" class="space-y-4">
        <p class="text-sm font-medium text-green-900 opacity-75">No has escrito a√∫n...</p>
      </div>
    </div>
  </section>

  <!-- C√°psula del tiempo con fondo azul e icono de cohete -->
  <section id="capsule" class="w-full max-w-xl mb-8 hidden">
    <div class="rounded-2xl bg-blue-100 border border-blue-300 p-6 shadow-md relative">
      <div class="flex items-center mb-4">
        <span class="text-3xl mr-2">üöÄ</span>
        <h2 class="text-2xl font-semibold text-blue-800">C√°psula del tiempo</h2>
      </div>
      <p class="mt-1 text-sm font-medium text-blue-900 mb-4">Un eco de tus pensamientos, viajando silenciosamente hacia un rinc√≥n lejano del ma√±ana.</p>
      <textarea id="capsuleMessage" class="w-full mt-2 p-4 rounded-xl shadow-inner bg-white border border-blue-300 focus:outline-none focus:ring-2 focus:ring-blue-300" rows="4" maxlength="500" placeholder="Tu mensaje secreto para el futuro..."></textarea>
      <div class="flex space-x-2 mt-3">
        <input type="date" id="capsuleDate" class="p-2 rounded-lg bg-white border border-blue-300 focus:outline-none">
        <input type="time" id="capsuleTime" class="p-2 rounded-lg bg-white border border-blue-300 focus:outline-none">
        <button id="capsuleBtn" class="px-4 py-2 rounded-lg bg-blue-500 text-white shadow-md hover:bg-blue-600 transition">Programar</button>
      </div>
    </div>
  </section>

  <section id="about" class="w-full max-w-xl mb-8 hidden">
    <div class="rounded-2xl bg-yellow-100 border border-yellow-300 p-6 shadow-md relative">
      <div class="flex items-center mb-4">
        <span class="text-3xl mr-2">‚ÑπÔ∏è</span>
        <h2 class="text-2xl font-semibold text-yellow-800">Acerca de & Preguntas Frecuentes</h2>
      </div>
      <details class="mb-2">
        <summary class="font-medium cursor-pointer">¬øPor qu√© Libre?</summary>
        <p class="mt-1 text-sm font-medium text-yellow-900 text-justify">
          Nuestra Filosof√≠a: La Botella lanzada al Mar.<br>
          Cada pensamiento que lanzas es como una botella con un mensaje que arrojas al mar. No sabes qui√©n la encontrar√°, ni d√≥nde, y ellos no sabr√°n qui√©n eres. Esta es la esencia de LIBRE: una conexi√≥n humana pura a trav√©s de las ideas, despojada de cualquier rastro de identidad o expectativa de respuesta.<br><br>
          No hay perfiles, no hay seguidores, no hay "me gusta". Solo palabras que viajan libremente.
        </p>
      </details>
      <details class="mb-2">
        <summary class="font-medium cursor-pointer">¬øPor qu√© no hay login ni perfiles?</summary>
        <p class="mt-1 text-sm font-medium text-yellow-900 text-justify">La ausencia de login y perfiles es el pilar central de la filosof√≠a de LIBRE. Queremos que te expreses sin la presi√≥n social, sin la necesidad de construir una imagen o de buscar validaci√≥n. Tus palabras son libres, t√∫ eres libre.</p>
      </details>
      <details>
        <summary class="font-medium cursor-pointer">¬øEs LIBRE realmente an√≥nimo?</summary>
        <p class="mt-1 text-sm font-medium text-yellow-900 text-justify">S√≠, absolutamente. No te pedimos nombre, email, ni ning√∫n dato personal. Tu pensamiento se lanza con un ID an√≥nimo generado en tu propio navegador, que no te identifica. El pa√≠s se determina por tu IP, pero no se vincula a tu persona y solo se usa para fines estad√≠sticos globales.</p>
      </details>
    </div>
  </section>

  <!-- Secci√≥n de escritura con frase inspiradora como placeholder y pensamiento del d√≠a debajo -->
  <section id="write" class="w-full max-w-xl mb-6">
    <textarea id="textarea" class="w-full p-4 rounded-xl shadow-inner bg-white border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-400" rows="4" maxlength="500"></textarea>
    <button id="sendBtn" class="mt-2 w-full text-center py-3 rounded-xl font-medium shadow-md hover:shadow-xl transition">Enviar pensamiento</button>
    <div id="thoughtOfDaySection" class="mt-3"></div>
  </section>

  <footer class="w-full max-w-xl text-center py-6">
    <p class="mb-2 text-sm font-medium">Si te gusta Libre, ap√≥yanos en Ko-fi:</p>
    <a href="https://ko-fi.com/libreantisocial" target="_blank" class="inline-block px-6 py-2 bg-yellow-400 rounded-full font-medium shadow hover:shadow-lg transition">‚òï Ap√≥yanos</a>
    <div class="mt-4 text-sm opacity-50">¬© 2025 Libre. Todos los derechos reservados.</div>
  </footer>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    // ... todas las funciones y configuraci√≥n igual que antes ...

    // ---- CONFIGURACI√ìN DE FIREBASE ----
    const firebaseConfig = {
      apiKey: "AIzaSyC7MKy2T8CFvpay4FBp8FTrVp8tpU0Niwc",
      authDomain: "libre-c5bf7.firebaseapp.com",
      projectId: "libre-c5bf7",
      storageBucket: "libre-c5bf7.firebasestorage.app",
      messagingSenderId: "339942652190",
      appId: "1:339942652190:web:595ce692456b9df806f10f"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // ---- FILTRO AVANZADO DE INSULTOS Y COMENTARIOS INAPROPIADOS ----
    const PALABRAS_PROHIBIDAS = [
      "puto", "puta", "mierda", "gilipollas", "idiota", "imbecil", "tonto",
      "fuck", "shit", "asshole", "bitch", "fag", "cunt", "dick", "porn", "sexo",
      "maricon", "polla", "verga", "co√±o", "cabron", "culiao", "jodete", "zorra", "perra", "sorete",
      "mongolo", "mongola", "mongolico", "mongolica", "mogolico", "mogolica", "retrasado", "retrasada",
      "subnormal", "soplapollas", "comechapas", "comepollas", "concha", "conchetumadre", "hijoputa",
      "hijo de puta", "hijueputa", "marica", "maricon", "mariconazo", "mariconaza", "puton", "a tomar por culo",
      "chinga tu madre", "la concha de la lora", "me cago en dios", "me cago en tus muertos", "me cago en la puta",
      "co√±o de tu madre", "mamag√ºevo", "mamaguevo", "moro de mierda", "mora de mierda", "negro de mierda", "negra de mierda",
      "panchito", "panchita", "sudaca", "mariposa", "mariposas", "mariposon", "mariposona", "mariquita", "bollera",
      "tortillera", "travelo", "pija", "culiadaso", "culiado", "culiar", "chupa pija", "poronga", "pito"
    ];

    function normalizaTexto(texto) {
      return texto
        .toLowerCase()
        .normalize("NFD").replace(/[\u0300-\u036f]/g, '')
        .replace(/[^a-z0-9\s]/gi, ' ')
        .replace(/\s{2,}/g, ' ')
        .trim();
    }

    function palabraProhibidaDetectada(texto) {
      const textoNormal = normalizaTexto(texto);
      for (let palabra of PALABRAS_PROHIBIDAS) {
        const palabraSeparada = palabra.split('').join('\\s*');
        const regex = new RegExp(`\\b(${palabra}|${palabraSeparada})\\b`, "i");
        if (regex.test(textoNormal)) return palabra;
      }
      return null;
    }

    // ---- FILTRO DE PALABRAS POSITIVAS ----
    const PALABRAS_POSITIVAS = [
      "gracias","feliz","amor","esperanza","paz","sonrisa","amigo","amistad","aprecio","vida","confianza","alegr√≠a","bien","abrazo","logro","√©xito","luz","brillante","positivo","apoyo","solidaridad","entusiasmo","creer","buen","bonito","hermoso","belleza","orgullo","inspirar","motivar","so√±ar","encanto","resiliencia"
    ];

    function cuentaPalabrasPositivas(texto) {
      let count = 0;
      const textoNorm = normalizaTexto(texto);
      for(const pos of PALABRAS_POSITIVAS) {
        const r = new RegExp(`\\b${pos}\\b`, "gi");
        count += (textoNorm.match(r)||[]).length;
      }
      return count;
    }

    // ---- FRASES DE INSPIRACI√ìN ----
    const FRASES_INSPIRACION = [
      "¬øQu√© har√≠as si no tuvieras miedo?",
      "Escribe algo que te gustar√≠a que el mundo supiera.",
      "¬øCu√°l es tu sue√±o m√°s grande?",
      "¬øQu√© te hace sonre√≠r hoy?",
      "¬øQu√© aprendiste esta semana?",
      "¬øQu√© le dir√≠as a tu yo del pasado?",
      "¬øPor qu√© est√°s agradecido hoy?",
      "¬øQu√© consejo le dar√≠as a alguien desconocido?",
      "¬øQu√© significa para ti la libertad?",
      "Escribe un deseo para el futuro.",
      "¬øQu√© es lo que m√°s valoras en la vida?",
      "¬øQu√© te inspira a seguir adelante?",
      "Comparte una peque√±a alegr√≠a de tu d√≠a.",
      "¬øQu√© cambiar√≠as del mundo si pudieras?",
      "¬øDe qu√© logro te sientes orgulloso?",
      "¬øQu√© palabra te representa hoy?",
      "¬øQu√© te gustar√≠a dejar como huella?",
      "¬øCon qu√© sue√±as cuando cierras los ojos?"
    ];
    function muestraFraseInspiracionTextarea() {
      const idx = Math.floor(Math.random() * FRASES_INSPIRACION.length);
      document.getElementById('textarea').placeholder = FRASES_INSPIRACION[idx];
    }

    // ---- GENERADOR AN√ìNIMO LOCAL ----
    function getAnonUserId() {
      let id = localStorage.getItem("libre_anon_id");
      if (!id) {
        id = "anon-" + Math.random().toString(36).substr(2, 15);
        localStorage.setItem("libre_anon_id", id);
      }
      return id;
    }

    // ---- EXPORTAR/IMPORTAR IDENTIFICADOR AN√ìNIMO ----
    function exportAnonId() {
      const id = getAnonUserId();
      window.prompt("Este es tu identificador an√≥nimo. C√≥pialo y gu√°rdalo en un lugar seguro para restaurar tu historial cuando quieras:", id);
    }
    function importAnonId() {
      const newId = window.prompt("Pega aqu√≠ tu identificador an√≥nimo guardado anteriormente:");
      if(newId) {
        localStorage.setItem("libre_anon_id", newId);
        loadMyThoughts();
        loadUserStats();
        alert("Identificador restaurado. Si escribiste pensamientos con ese ID, ahora deber√≠as verlos en tu historial.");
      }
    }

    // ---- DETECTAR PA√çS ----
    let userCountry = "Desconocido";
    async function detectCountry() {
      try {
        const res = await axios.get("https://ipinfo.io/json?token=ec664cefb36ece");
        userCountry = res.data.country || "Desconocido";
      } catch {
        userCountry = "Desconocido";
      }
    }
    detectCountry();

    // ---- PENSAMIENTO DEL D√çA (ahora sutil, debajo de escribir) ----
    async function loadThoughtOfDay() {
      const today = new Date();
      const ymd = today.getUTCFullYear() + '-' + (today.getUTCMonth()+1).toString().padStart(2,'0') + '-' + today.getUTCDate().toString().padStart(2,'0');
      const section = document.getElementById('thoughtOfDaySection');
      section.innerHTML = "<span class='font-semibold text-indigo-700'>Pensamiento del d√≠a:</span> <span class='text-gray-700'>Cargando...</span>";
      const snapshot = await db.collection("thoughts").get();
      const docs = snapshot.docs;
      if (docs.length === 0) {
        section.innerHTML = "";
        return;
      }
      let hash = 0;
      for(let c of ymd) hash = ((hash<<5)-hash) + c.charCodeAt(0);
      hash = Math.abs(hash);
      const idx = hash % docs.length;
      const data = docs[idx].data();
      section.innerHTML = `
        <div class="my-1 px-3 py-2 rounded-md border border-indigo-100 bg-indigo-50 text-[.97rem] italic text-indigo-900 shadow-sm flex flex-col items-start">
          <span class="block mb-1 font-medium text-indigo-700 text-xs">Pensamiento del d√≠a</span>
          <span style="font-size:.97rem;" class="text-indigo-800">${data.text}</span>
          <span class="block mt-1 text-xs text-indigo-600 font-semibold">${data.country || "üåê"}</span>
        </div>
      `;
    }

    // ---- Modo botella al mar, cadena de pensamientos, escribir, historial, estad√≠sticas, rankings, mapa, etc ----
    // ...[El resto de funciones de la versi√≥n anterior: randomBottleBtn, chainModeBtn, renderChain, sendBtn, loadMyThoughts, loadUserStats, loadGlobalCount, loadGlobalThoughts, loadPositiveWordsRanking, loadCountryRanking, loadMap, loadCapsule, showTab]...
    // [No se repite para ahorrar espacio, pero es igual a lo entregado previamente. Puedes copiar y pegar todo el bloque anterior bajo <script> aqu√≠.]

    // ---- LOGO ANIMACI√ìN ----
    window.onload = function() {
      const textLogo = document.getElementById('textLogo');
      const imgLogo = document.getElementById('logolibre');
      textLogo.classList.remove('logo-hidden');
      textLogo.classList.add('logo-shown');
      imgLogo.classList.remove('visible');
      setTimeout(() => {
        textLogo.classList.remove('logo-shown');
        textLogo.classList.add('logo-hidden');
      }, 2000);
      setTimeout(() => {
        imgLogo.classList.add('visible');
      }, 3500);
      loadGlobalCount();
      loadGlobalThoughts();
      loadCountryRanking();
      loadMap();
      loadPositiveWordsRanking();
      muestraFraseInspiracionTextarea();
      loadUserStats();
      loadMyThoughts();
      loadThoughtOfDay();
    };

    // Cambiar frase inspiradora al recargar
    // Si quieres que cambie al enfocar el textarea, descomenta la siguiente l√≠nea:
    // document.getElementById('textarea').addEventListener('focus', muestraFraseInspiracionTextarea);

  </script>
</body>
</html>
