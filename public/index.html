<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LIBRE</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        /* ------------------- */
        /* VARIABLES Y RESET   */
        /* ------------------- */
        :root {
            /* Paleta de colores "Sol de Verano" (Cálida) */
            --bg-color-light: #FFFBEA; /* Un amarillo crema muy suave */
            --text-color-light: #3E2723; /* Marrón oscuro para el texto */
            --card-bg-light: #FFFFFF;
            --border-color-light: #F5E6A3; /* Borde amarillo pálido */
            --primary-color-light: #E65100; /* Naranja intenso como acento */
            --primary-hover-light: #FF6F00; /* Naranja más brillante al pasar el ratón */
            --secondary-text-light: #795548; /* Marrón medio para texto secundario */
            --featured-bg-light: #FFF8E1; /* Fondo destacado muy claro */

            /* Paleta Oscura (se mantiene igual para contraste) */
            --bg-color-dark: #121212;
            --text-color-dark: #EAEAEA;
            --card-bg-dark: #1E1E1E;
            --border-color-dark: #333333;
            --primary-color-dark: #4dabf7;
            --primary-hover-dark: #74c0fc;
            --secondary-text-dark: #A0A0A0;
            --featured-bg-dark: #2a2a3a;

            --font-family: 'Inter', sans-serif;
            --border-radius: 12px;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            --shadow-dark: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        /* Asignación de variables inicial */
        body {
            --bg-color: var(--bg-color-light);
            --text-color: var(--text-color-light);
            --card-bg: var(--card-bg-light);
            --border-color: var(--border-color-light);
            --primary-color: var(--primary-color-light);
            --primary-hover: var(--primary-hover-light);
            --secondary-text: var(--secondary-text-light);
            --featured-bg: var(--featured-bg-light);
            --current-shadow: var(--shadow);
        }

        /* Modo Oscuro Automático */
        @media (prefers-color-scheme: dark) {
            body {
                --bg-color: var(--bg-color-dark);
                --text-color: var(--text-color-dark);
                --card-bg: var(--card-bg-dark);
                --border-color: var(--border-color-dark);
                --primary-color: var(--primary-color-dark);
                --primary-hover: var(--primary-hover-dark);
                --secondary-text: var(--secondary-text-dark);
                --featured-bg: var(--featured-bg-dark);
                --current-shadow: var(--shadow-dark);
            }
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
            line-height: 1.6;
        }

        /* ------------------- */
        /* LAYOUT Y GLOBALES   */
        /* ------------------- */
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem 1rem;
        }

        button {
            font-family: var(--font-family);
            cursor: pointer;
            border: none;
            border-radius: var(--border-radius);
            padding: 10px 18px;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.2s ease-in-out;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--primary-hover);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .btn-secondary {
            background-color: transparent;
            color: var(--secondary-text);
            border: 1px solid var(--border-color);
        }
        
        .btn-secondary:hover {
            background-color: var(--border-color);
            color: var(--text-color);
        }

        /* ------------------- */
        /* CABECERA Y LOGO     */
        /* ------------------- */
        .header {
            text-align: center;
            padding: 2rem 0;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 2rem;
        }

        .logo-container {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .logo-text {
            font-size: 2.5rem;
            font-weight: 300;
        }

        .logo-text span {
            font-weight: 500;
        }

        .slogan {
            max-width: 600px;
            margin: 0 auto;
            font-size: 1rem;
            color: var(--secondary-text);
            line-height: 1.5;
        }

        /* ------------------- */
        /* FRASE DESTACADA     */
        /* ------------------- */
        .featured-thought-wrapper {
            background-color: var(--featured-bg);
            padding: 2rem;
            margin-bottom: 2rem;
            border-radius: var(--border-radius);
            text-align: center;
            transition: background-color 0.3s;
        }
        .featured-thought-wrapper h3 {
            margin-bottom: 1rem;
            font-weight: 400;
            color: var(--secondary-text);
        }
        #featured-thought-card {
            background: none;
            border: none;
            box-shadow: none;
        }
        #featured-thought-card .thought-text {
            font-size: 1.5rem;
            font-style: italic;
        }
        #featured-thought-card .thought-meta {
            justify-content: center;
        }

        /* ------------------- */
        /* FORMULARIO PUBLICAR */
        /* ------------------- */
        .thought-form {
            background-color: var(--card-bg);
            padding: 1.5rem;
            border-radius: var(--border-radius);
            box-shadow: var(--current-shadow);
            margin-bottom: 2rem;
            transition: background-color 0.3s, box-shadow 0.3s;
        }

        textarea, input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: var(--font-family);
            font-size: 1rem;
            margin-bottom: 1rem;
            transition: all 0.3s;
        }

        textarea:focus, input[type="text"]:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px color-mix(in srgb, var(--primary-color) 20%, transparent);
        }

        .form-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #char-counter {
            color: var(--secondary-text);
            font-size: 0.9rem;
        }

        /* ------------------- */
        /* LISTA DE FRASES     */
        /* ------------------- */
        .thoughts-feed {
            display: grid;
            gap: 1.5rem;
        }

        .thought-card {
            background-color: var(--card-bg);
            padding: 1.5rem;
            border-radius: var(--border-radius);
            box-shadow: var(--current-shadow);
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            gap: 1rem;
            transition: all 0.3s;
        }

        .thought-text {
            font-size: 1.1rem;
            line-height: 1.7;
            white-space: pre-wrap; /* Mantiene los saltos de línea */
        }

        .thought-meta {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: var(--secondary-text);
            font-size: 0.9rem;
        }

        .thought-author {
            font-weight: 500;
            color: var(--text-color);
        }

        .thought-location .flag {
            font-size: 1.2rem;
            margin-right: 0.25rem;
        }

        .thought-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            border-top: 1px solid var(--border-color);
            padding-top: 1rem;
        }
        
        .thought-actions button {
            font-size: 0.85rem;
            padding: 6px 12px;
        }

        /* ------------------- */
        /* MODO LECTURA        */
        /* ------------------- */
        .silent-mode-controls {
            text-align: center;
            margin: 2rem 0;
        }

        body.silent-mode .thought-form,
        body.silent-mode .thought-actions,
        body.silent-mode .silent-mode-controls,
        body.silent-mode .header,
        body.silent-mode .featured-thought-wrapper {
            display: none;
        }

        body.silent-mode .thought-card {
            box-shadow: none;
            border: none;
            background: transparent;
            padding: 2rem 0;
            border-bottom: 1px solid var(--border-color);
            border-radius: 0;
        }
        
        body.silent-mode .container {
            padding-top: 1rem;
        }

        /* ------------------- */
        /* CONFIRMACIÓN Y ANIMS*/
        /* ------------------- */
        .toast-notification {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background-color: var(--card-bg-dark);
            color: var(--text-color-dark);
            padding: 1rem 1.5rem;
            border-radius: var(--border-radius);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            z-index: 1000;
            opacity: 0;
            transition: transform 0.5s ease-out, opacity 0.5s ease-out;
        }

        .toast-notification.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        @keyframes wind-blow {
            0% { opacity: 0; transform: translateX(-50px) scale(0.8); }
            50% { opacity: 0.7; }
            100% { opacity: 0; transform: translateX(50px) scale(1.2); }
        }

        .wind-animation::after {
            content: '🌬️';
            position: absolute;
            font-size: 2rem;
            opacity: 0;
            animation: wind-blow 1.5s ease-out forwards;
        }
        
        /* ------------------- */
        /* RESPONSIVE DESIGN   */
        /* ------------------- */
        @media (max-width: 600px) {
            .container {
                padding: 1rem;
            }
            .logo-text {
                font-size: 2rem;
            }
            .slogan {
                font-size: 0.9rem;
            }
            .form-footer {
                flex-direction: column;
                gap: 1rem;
                align-items: stretch;
            }
            .btn-primary {
                width: 100%;
            }
            #char-counter {
                text-align: center;
            }
        }

    </style>
</head>
<body>

    <div class="container">
        <!-- Cabecera -->
        <header class="header">
            <div class="logo-container">
                <h1 class="logo-text">🌬️ <span>LIBRE</span></h1>
            </div>
            <p class="slogan" data-i18n="slogan">Es un espacio silencioso donde cualquier persona, desde cualquier rincón del mundo, puede soltar un pensamiento. No hay likes. No hay cuentas. Solo palabras. Liviano, anónimo, humano.</p>
        </header>

        <!-- Frase Destacada -->
        <div class="featured-thought-wrapper">
            <h3 data-i18n="featuredTitle">Pensamiento Destacado</h3>
            <div id="featured-thought-card" class="thought-card" style="display: none;">
                <!-- Contenido se inyecta con JS -->
            </div>
        </div>

        <!-- Formulario para publicar -->
        <form class="thought-form" id="thought-form">
            <textarea id="thought-input" maxlength="500" placeholder="Escribe aquí tu pensamiento..." data-i18n-placeholder="formPlaceholder"></textarea>
            <div class="form-footer">
                <input type="text" id="name-input" placeholder="Nombre (opcional)" data-i18n-placeholder="namePlaceholder" style="width: 40%;">
                <span id="char-counter">500</span>
                <button type="submit" class="btn-primary" id="submit-button" data-i18n="submitButton">Soltar</button>
            </div>
        </form>

        <!-- Controles Modo Lectura -->
        <div class="silent-mode-controls">
            <button id="toggle-silent-mode" class="btn-secondary" data-i18n="toggleSilent">Modo Lectura Silenciosa</button>
        </div>

        <!-- Lista de frases -->
        <div class="thoughts-feed" id="thoughts-feed">
            <!-- Las frases se cargarán aquí desde Firebase -->
        </div>
    </div>

    <!-- Notificación Toast -->
    <div id="toast-notification" class="toast-notification"></div>

    <!-- Scripts -->
    <script type="module">
        // Importar funciones de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, onSnapshot, serverTimestamp, orderBy, doc, updateDoc, increment } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURACIÓN DE FIREBASE ---
        // Se utiliza la configuración que proporcionaste.
        const firebaseConfig = {
            apiKey: "AIzaSyC7MKy2T8CFvpay4FBp8FTrVp8tpU0Niwc",
            authDomain: "libre-c5bf7.firebaseapp.com",
            projectId: "libre-c5bf7",
            storageBucket: "libre-c5bf7.appspot.com",
            messagingSenderId: "339942652190",
            appId: "1:339942652190:web:595ce692456b9df806f10f"
        };

        // Inicializar Firebase, Auth y Firestore
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- DICCIONARIO DE TRADUCCIONES (i18n) ---
        const translations = {
            es: {
                slogan: "es un espacio silencioso donde cualquier persona, desde cualquier rincón del mundo, puede soltar un pensamiento. No hay likes. No hay cuentas. Solo palabras. Liviano, anónimo, humano.",
                featuredTitle: "Pensamiento Destacado",
                formPlaceholder: "Escribe aquí tu pensamiento...",
                namePlaceholder: "Nombre (opcional)",
                submitButton: "Soltar",
                toggleSilent: "Modo Lectura Silenciosa",
                toggleSilentExit: "Salir del Modo Silencioso",
                replyButton: "Responder",
                reportButton: "Reportar",
                reportedMessage: "Reportado",
                authorLabel: "Por",
                anonymous: "Anónimo",
                toastMessages: ["Soltado.", "Tu frase ya no te pertenece.", "Libre en el viento.", "Un pensamiento menos."],
                loading: "Cargando..."
            },
            en: {
                slogan: "is a silent space where anyone, from any corner of the world, can release a thought. No likes. No accounts. Just words. Light, anonymous, human.",
                featuredTitle: "Featured Thought",
                formPlaceholder: "Write your thought here...",
                namePlaceholder: "Name (optional)",
                submitButton: "Release",
                toggleSilent: "Silent Reading Mode",
                toggleSilentExit: "Exit Silent Mode",
                replyButton: "Reply",
                reportButton: "Report",
                reportedMessage: "Reported",
                authorLabel: "By",
                anonymous: "Anonymous",
                toastMessages: ["Released.", "Your thought no longer belongs to you.", "Free in the wind.", "One less thought."],
                loading: "Loading..."
            }
        };

        // --- ESTADO DE LA APLICACIÓN ---
        let currentLang = 'es';
        let allThoughts = [];

        // --- ELEMENTOS DEL DOM ---
        const thoughtForm = document.getElementById('thought-form');
        const thoughtInput = document.getElementById('thought-input');
        const nameInput = document.getElementById('name-input');
        const charCounter = document.getElementById('char-counter');
        const thoughtsFeed = document.getElementById('thoughts-feed');
        const submitButton = document.getElementById('submit-button');
        const toast = document.getElementById('toast-notification');
        const featuredThoughtCard = document.getElementById('featured-thought-card');
        const toggleSilentModeBtn = document.getElementById('toggle-silent-mode');

        // --- FUNCIONES PRINCIPALES ---

        /**
         * Detecta el idioma del navegador y aplica las traducciones.
         */
        function setLanguage() {
            const userLang = navigator.language || navigator.userLanguage;
            currentLang = userLang.startsWith('en') ? 'en' : 'es';

            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (translations[currentLang][key]) {
                    el.textContent = translations[currentLang][key];
                }
            });
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                const key = el.getAttribute('data-i18n-placeholder');
                 if (translations[currentLang][key]) {
                    el.placeholder = translations[currentLang][key];
                }
            });
        }

        /**
         * Obtiene la geolocalización del usuario a través de su IP.
         * Utiliza un servicio externo gratuito.
         * @returns {Promise<object|null>} Objeto con datos de geolocalización o null si falla.
         */
        async function getGeoInfo() {
            try {
                const response = await fetch('https://ipapi.co/json/');
                if (!response.ok) throw new Error('Failed to fetch geo info');
                const data = await response.json();
                return {
                    city: data.city,
                    country: data.country_name,
                    country_code: data.country_code
                };
            } catch (error) {
                console.error("Error getting geolocation:", error);
                return { city: 'Lugar Desconocido', country: 'Mundo', country_code: 'XX' };
            }
        }
        
        /**
         * Convierte un código de país de 2 letras en un emoji de bandera.
         * @param {string} countryCode - El código del país (ej. "ES").
         * @returns {string} El emoji de la bandera.
         */
        function getFlagEmoji(countryCode) {
            if (!countryCode || countryCode.length !== 2) return '🏳️';
            const codePoints = countryCode
                .toUpperCase()
                .split('')
                .map(char => 127397 + char.charCodeAt());
            return String.fromCodePoint(...codePoints);
        }

        /**
         * Muestra una notificación toast con un mensaje poético.
         */
        function showPoeticToast() {
            const messages = translations[currentLang].toastMessages;
            const message = messages[Math.floor(Math.random() * messages.length)];
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        /**
         * Activa una animación de viento junto al botón de enviar.
         */
        function triggerWindAnimation() {
            submitButton.classList.add('wind-animation');
            setTimeout(() => {
                submitButton.classList.remove('wind-animation');
            }, 1500);
        }

        /**
         * Maneja el envío del formulario para publicar una nueva frase.
         * @param {Event} e - El evento del formulario.
         */
        async function handleFormSubmit(e) {
            e.preventDefault();
            const text = thoughtInput.value.trim();
            const name = nameInput.value.trim();

            if (!text) return;

            submitButton.disabled = true;
            submitButton.textContent = translations[currentLang].loading;

            try {
                const geo = await getGeoInfo();
                
                // Añadir el documento a Firestore
                await addDoc(collection(db, "thoughts"), {
                    text: text,
                    name: name || translations[currentLang].anonymous,
                    city: geo.city,
                    country: geo.country,
                    country_code: geo.country_code,
                    createdAt: serverTimestamp(),
                    reports: 0
                });

                thoughtInput.value = '';
                nameInput.value = '';
                charCounter.textContent = '500';
                thoughtInput.dispatchEvent(new Event('input')); // Reset counter color

                showPoeticToast();
                triggerWindAnimation();

            } catch (error) {
                console.error("Error adding document: ", error);
                alert("Hubo un error al enviar tu pensamiento. Inténtalo de nuevo.");
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = translations[currentLang].submitButton;
            }
        }

        /**
         * Crea el HTML para una tarjeta de frase.
         * @param {object} thoughtData - Los datos de la frase desde Firestore.
         * @returns {string} El string HTML de la tarjeta.
         */
        function createThoughtCardHTML(thoughtData) {
            const { id, text, name, city, country, country_code } = thoughtData;
            const flag = getFlagEmoji(country_code);
            const authorName = name || translations[currentLang].anonymous;

            return `
                <div class="thought-text">${text.replace(/\n/g, '<br>')}</div>
                <div class="thought-meta">
                    <span class="thought-author">${authorName}</span>
                    <span class="thought-location">
                        <span class="flag">${flag}</span> ${city}, ${country}
                    </span>
                </div>
                <div class="thought-actions">
                    <button class="btn-secondary btn-report" data-id="${id}" data-reported="false">${translations[currentLang].reportButton}</button>
                </div>
            `;
        }

        /**
         * Renderiza todas las frases en el feed.
         * @param {Array<object>} thoughts - Array de objetos de frases.
         */
        function renderThoughts(thoughts) {
            thoughtsFeed.innerHTML = '';
            thoughts.forEach(thought => {
                const card = document.createElement('div');
                card.className = 'thought-card';
                card.id = `thought-${thought.id}`;
                card.innerHTML = createThoughtCardHTML(thought);
                thoughtsFeed.appendChild(card);
            });
        }
        
        /**
         * Escucha los cambios en la colección de frases en tiempo real.
         * Implementa la expiración de 30 días en el lado del cliente.
         */
        function listenForThoughts() {
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

            const q = query(
                collection(db, "thoughts"), 
                where("createdAt", ">", thirtyDaysAgo),
                orderBy("createdAt", "desc")
            );

            onSnapshot(q, (querySnapshot) => {
                allThoughts = [];
                querySnapshot.forEach((doc) => {
                    allThoughts.push({ id: doc.id, ...doc.data() });
                });
                renderThoughts(allThoughts);
                updateFeaturedThought();
            }, (error) => {
                console.error("Error listening for thoughts:", error);
            });
        }
        
        /**
         * Actualiza la frase destacada con una aleatoria.
         */
        function updateFeaturedThought() {
            if (allThoughts.length === 0) {
                featuredThoughtCard.style.display = 'none';
                return;
            }
            const randomThought = allThoughts[Math.floor(Math.random() * allThoughts.length)];
            featuredThoughtCard.innerHTML = createThoughtCardHTML(randomThought);
            // Ocultamos los botones de acción en la destacada
            const actions = featuredThoughtCard.querySelector('.thought-actions');
            if (actions) actions.style.display = 'none';
            
            featuredThoughtCard.style.display = 'block';
        }

        /**
         * Maneja el click en los botones de reportar.
         * @param {Event} e - El evento del click.
         */
        async function handleFeedClick(e) {
            if (e.target.classList.contains('btn-report')) {
                const button = e.target;
                const thoughtId = button.dataset.id;
                const isReported = button.dataset.reported === 'true';

                if (isReported) return; // Ya reportado en esta sesión

                button.disabled = true;

                try {
                    const thoughtRef = doc(db, "thoughts", thoughtId);
                    await updateDoc(thoughtRef, {
                        reports: increment(1)
                    });
                    button.textContent = translations[currentLang].reportedMessage;
                    button.dataset.reported = 'true';
                } catch (error) {
                    console.error("Error reporting thought:", error);
                    button.disabled = false;
                }
            }
        }
        
        /**
         * Alterna el modo de lectura silenciosa.
         */
        function toggleSilentMode() {
            document.body.classList.toggle('silent-mode');
            if (document.body.classList.contains('silent-mode')) {
                toggleSilentModeBtn.textContent = translations[currentLang].toggleSilentExit;
            } else {
                toggleSilentModeBtn.textContent = translations[currentLang].toggleSilent;
            }
        }

        // --- INICIALIZACIÓN Y EVENT LISTENERS ---

        // Actualiza el contador de caracteres del textarea.
        thoughtInput.addEventListener('input', () => {
            const remaining = 500 - thoughtInput.value.length;
            charCounter.textContent = remaining;
            charCounter.style.color = remaining < 20 ? '#dc3545' : 'var(--secondary-text)';
        });

        // Envío del formulario.
        thoughtForm.addEventListener('submit', handleFormSubmit);
        
        // Clicks en el feed para reportar.
        thoughtsFeed.addEventListener('click', handleFeedClick);

        // Botón para modo silencioso.
        toggleSilentModeBtn.addEventListener('click', toggleSilentMode);

        // Actualizar frase destacada cada 20 segundos.
        setInterval(updateFeaturedThought, 20000);

        // Carga inicial de la app.
        document.addEventListener('DOMContentLoaded', async () => {
            // Es crucial autenticarse (incluso anónimamente) ANTES de intentar leer la base de datos.
            try {
                await signInAnonymously(auth);
                console.log("Signed in anonymously to Firebase.");
                
                // Una vez autenticado, se puede cargar el resto de la app.
                setLanguage();
                listenForThoughts();

            } catch (error) {
                console.error("Anonymous sign-in failed: ", error);
                alert("No se pudo conectar con el servidor. Por favor, refresca la página.");
            }
        });

    </script>
</body>
</html>
